#!/bin/bash
#                      模块三: HISAT2 序列比对与 Samtools 排序 

# --- 脚本设置：出错立即退出 ---
set -e
set -o pipefail

# --- 1. 定义通用变量 (来自您的脚本) ---
QC_OUT_DIR="/data1/wcc/transcriptome/1.fastp/results/1_qc"
HISAT2_INDEX_PREFIX="/data1/wcc/transcriptome/results/0_reference/hisat2_index/genome_index"
MAPPING_OUT_DIR="/data1/wcc/transcriptome/3.map"
THREADS=16
# --- 2. 全局准备工作 ---
echo "--- [全局准备] 检查索引并创建输出目录... ---"
# 创建输出目录
echo "确保输出目录存在: ${MAPPING_OUT_DIR}"
mkdir -p "${MAPPING_OUT_DIR}"
# --- 3. 自动化核心：发现样本并循环处理 ---
echo "--- [核心处理] 开始查找并处理所有在 '${QC_OUT_DIR}' 中的样本... ---"
for READ1_CLEAN_PATH in ${QC_OUT_DIR}/*_clean_1.fastq.gz; do
    # --- 循环内部：为当前样本定义变量 ---
      # 从R1文件路径中提取样本名
    SAMPLE_NAME=$(basename "${READ1_CLEAN_PATH}" | sed 's/_clean_1\.fastq\.gz$//')
    echo ">>> 正在处理样本: ${SAMPLE_NAME}"
     # 根据样本名，构建R2输入文件和所有输出文件的完整路径
    READ2_CLEAN_PATH="${QC_OUT_DIR}/${SAMPLE_NAME}_clean_2.fastq.gz"
    SORTED_BAM_OUT="${MAPPING_OUT_DIR}/${SAMPLE_NAME}.sorted.bam"
    SUMMARY_FILE_OUT="${MAPPING_OUT_DIR}/${SAMPLE_NAME}.hisատ2.summary.txt"
    # --- 循环内部：健全性检查 ---
    if [ ! -f "${READ2_CLEAN_PATH}" ]; then
        echo "[警告] 找不到样本 ${SAMPLE_NAME} 对应的R2文件: ${READ2_CLEAN_PATH}。跳过此样本。"
        continue
    fi
     # --- 循环内部：运行核心命令 ---
    echo "开始比对和排序..."
    hisat2 \
        -p ${THREADS} \
        -x "${HISAT2_INDEX_PREFIX}" \
        -1 "${READ1_CLEAN_PATH}" \
        -2 "${READ2_CLEAN_PATH}" \
        --summary-file "${SUMMARY_FILE_OUT}" \
    | samtools view -bS - \
    | samtools sort -@ ${THREADS} -o "${SORTED_BAM_OUT}"
    # --- 循环内部：验证与索引 ---
    echo ""
    echo "--- [验证] 检查 '${SAMPLE_NAME}' 的输出... ---"
    if [ -s "${SORTED_BAM_OUT}" ]; then
        echo "[成功] BAM文件已成功创建: ${SORTED_BAM_OUT}"
        echo "正在为BAM文件创建索引..."
        echo "正在为BAM文件创建CSI索引 (因为基因组较大)..."
        # 使用 -c 参数来创建 CSI 索引
        samtools index -c "${SORTED_BAM_OUT}"
    
        # 验证 CSI 索引文件 (.csi) 是否已创建
        if [ -f "${SORTED_BAM_OUT}.csi" ]; then
            echo "CSI索引创建完成: ${SORTED_BAM_OUT}.csi"
        else
            echo "[警告] CSI索引文件创建失败"
        fi
    fi
done

echo ""
echo "========================================================"
echo "--- [完成] 所有样本的比对处理已全部完成。 ---"
echo "========================================================"
